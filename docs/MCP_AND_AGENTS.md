# Агенты и MCP

## Роли агентов (AGENTS.md)

Команда: Аналитик → Разработчик → Тестировщик. Все читают **agent.md** как источник ограничений (Local-first, BYOM, zero backend).

## Где что настраивается

### Cursor

- **Правила для агентов**: в репозитории используются `AGENTS.md` и `agent.md` (workspace rules). Доп. правила можно положить в `.cursor/rules/*.mdc` (если появятся).
- **MCP в Cursor**: настраивается в настройках Cursor (Settings → MCP), не в репозитории. URL и список серверов задаются там. Репозиторий не содержит конфига MCP для Cursor.

### Continue.dev

- В репозитории есть **.continue/mcpServers/new-mcp-server.yaml**:
  - Указан сервер: `http://i1c-mcp:8007/mcp`.
  - Это конфиг для [Continue](https://continue.dev), а не для Cursor.
- Если вы используете Cursor, MCP нужно настроить отдельно в Cursor и при необходимости указать тот же URL (`http://i1c-mcp:8007/mcp`), если сервер общий.

## Проверка связки агентов и MCP

1. **Агенты (без MCP)**  
   - Убедиться, что в Cursor подхватываются workspace rules: открыть чат и проверить, что ответы учитывают AGENTS.md/agent.md (Local-first, BYOM, текущая страница, MCP).

2. **MCP в Cursor**  
   - В Cursor: Settings → MCP.  
   - Добавить нужный MCP server (host/URL и имя).  
   - Если сервер — `i1c-mcp:8007`, на клиенте должен быть доступ до этого хоста (сеть/DNS).  
   - Проверка: в чате Cursor вызвать инструмент, который предоставляет MCP-сервер.

3. **MCP в Continue**  
   - Запустить Continue с конфигом из `.continue/mcpServers/new-mcp-server.yaml`.  
   - Убедиться, что хост `i1c-mcp` резолвится и порт 8007 доступен.  
   - Проверить вызов инструментов этого MCP в Continue.

## MCP внутри расширения (PageAI)

В расширении MCP используется **только в настройках**:

- **Реализовано:**
  - Конфиг MCP-серверов (JSON в настройках popup/panel/options).
  - Проверка подключения: `checkMcpConnection(url)` — отправка `initialize` на сервер.
  - Список инструментов: `listMcpTools(url)` — `initialize` + `tools/list`, отображение в UI (вкл/выкл серверов).
- **Реализовано полностью (интеграция агента с MCP):**
  - Вызов инструмента: `callMcpTool(serverUrl, toolName, args?, options?)` в `src/mcp/client.ts`.
  - Загрузка инструментов из настроек: `getEnabledMcpToolsWithMap()` в `src/mcp/agent-tools.ts` — читает `mcpServersConfig` и `mcpServersEnabled` из storage, для каждого включённого сервера вызывает `listMcpTools`, возвращает массив инструментов в формате OpenAI и карту «имя инструмента → сервер (url, headers)».
  - Один раунд чата с инструментами: `chatWithLLMOneRound(messages, options)` в `src/llm/client.ts` — отправляет в LM Studio запрос с полем `tools` и `tool_choice: "auto"`, возвращает либо `{ text }`, либо `{ tool_calls }`, либо `{ error }`.
  - Цикл агента в background: при отправке сообщения в чат (и в потоковом, и в обычном режиме) сначала вызывается `getEnabledMcpToolsWithMap()`. Если есть включённые MCP-инструменты, выполняется `runAgentStreamWithMcpTools` / `runAgentWithMcpTools`: в цикле (до 5 итераций) вызывается LLM с инструментами; при ответе с `tool_calls` для каждого вызова выполняется `callMcpTool`, результаты добавляются в диалог как сообщения с ролью `tool`, затем снова запрос к LLM; при ответе с текстом — возврат пользователю. В стриме после каждого раунда с tool_calls в UI отправляется `reasoning_step` (размышления + вызовы), чтобы сохранялась полная цепочка рассуждений.

**Итог:** агент (LLM) **вызывает** подключённые MCP-инструменты из чата расширения, если в настройках включён хотя бы один MCP-сервер и модель поддерживает function calling (tool_calls).

### Как любой ИИ узнаёт об инструментах

Чтобы **любой** подключённый к чату ИИ (LM Studio, OpenAI-совместимый бэкенд и др.) знал о доступных инструментах и не отвечал «инструменты не подключены»:

1. **При каждом запросе** в чат загружается статус MCP (`getEnabledMcpToolsWithMap`): список инструментов и флаг `mcpConfigured` (есть ли в настройках хотя бы один сервер).
2. **Системный промпт всегда** дополняется блоком о статусе инструментов (`buildSystemPromptWithToolStatus`):
   - **Инструменты загружены:** в промпт явно пишется `[TOOLS CONNECTED]`, перечисляются доступные инструменты и указание вызывать их через протокол (tool_calls / function calling). Текст предписывает не говорить, что инструменты не подключены.
   - **MCP настроен, но инструменты не загрузились:** пишется `[MCP CONFIGURED]` и предлагается сообщить пользователю проверить сервер, а не утверждать, что «инструменты не подключены к чату».
   - **MCP не настроен:** блок не добавляется.
3. Этот системный промпт передаётся и при вызове с инструментами (agent loop), и при обычном ответе без инструментов (стрим или один запрос). Таким образом, нейросеть всегда получает явное указание: инструменты подключены, настроены, или не настроены — и должна вызывать их по протоколу (tool_calls), когда они доступны.

## Итог

- **Агенты**: правила в AGENTS.md + agent.md; связка «агенты — репозиторий» работает через эти файлы.  
- **MCP Cursor**: настраивается в Cursor, репозиторий конфига не содержит.  
- **MCP Continue**: конфиг в `.continue/mcpServers/new-mcp-server.yaml`; работоспособность зависит от доступности `http://i1c-mcp:8007/mcp`.  
- **MCP в расширении**: настройка серверов, список инструментов и **полноценный вызов инструментов** агентом (LLM) из чата; цепочка размышлений и вызовов сохраняется в ответе.

### Просмотр текущей страницы и саммари

Расширение умеет передавать **контент текущей вкладки** модели и запрашивать по нему краткое саммари:

- Если пользователь задаёт вопрос, явно отсылающий к текущей странице (например «о чём эта страница?», «кратко перескажи», «что здесь написано?»), content script извлекает текст страницы и метаданные, background запрашивает у LLM саммари по этому контенту.
- Ответ приходит с ссылкой на источник (текущая страница). Данные не уходят в облако — только на настроенный пользователем LLM endpoint.
